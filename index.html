<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Villa Guest ID Manager</title>

  <!-- React, Babel, Tailwind (single-file usage) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAKElEQVR4AWMYeP///xkYGBgYGRgY/4YGBgYGBhA0TAxMDAwMDAwAAByGwzqKzJ3tQAAAABJRU5ErkJggg==" />
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ---------------- FIREBASE CONFIG ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyC7UUuinlN5BGbjAOCTVTjQH0ojiO63dPA",
      authDomain: "villa-id-manager.firebaseapp.com",
      projectId: "villa-id-manager",
      storageBucket: "villa-id-manager",   // exact bucket name
      messagingSenderId: "741560826934",
      appId: "1:741560826934:web:ded52efe671d6d7200ec97",
      measurementId: "G-BFJVWVRJGW"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const storage = firebase.storage();
    const db = firebase.firestore();

    // try silent anonymous sign-in at load (no await here â€” individual ops will ensure sign-in)
    auth.signInAnonymously().catch(e => console.warn('Initial anon sign-in error', e));


    // ---------------- SVG ICONS ----------------
    const Icon = (props) => <svg {...props} width={props.size||24} height={props.size||24} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"/>;
    const Upload = ({size=24}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>);
    const Calendar = ({size=20}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>);
    const FileText = ({size=20}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>);
    const Eye = ({size=20}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>);
    const Trash2 = ({size=20}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>);
    const X = ({size=20}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);


    // ---------------- App Component ----------------
    function App() {

      const [stays, setStays] = useState([]);
      const [loading, setLoading] = useState(true);

      const [showUpload, setShowUpload] = useState(false);
      const [showView, setShowView] = useState(false);
      const [selectedStay, setSelectedStay] = useState(null);

      const [form, setForm] = useState({ guestName: '', checkInDate: '', checkOutDate: '', files: [] });
      const [saving, setSaving] = useState(false);

      const fileInputRef = useRef(null);

      // Listen for stays collection
      useEffect(() => {
        const unsub = db.collection('stays').orderBy('checkInDate','desc').onSnapshot(snap => {
          const arr = [];
          snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
          setStays(arr);
          setLoading(false);
        }, err => {
          console.error('Firestore snapshot error', err);
          setLoading(false);
        });

        return unsub;
      }, []);

      // Helper to ensure anonymous auth present
      async function ensureAnonAuth() {
        if (firebase.auth().currentUser) return firebase.auth().currentUser;
        try {
          const res = await firebase.auth().signInAnonymously();
          console.log('Signed in anonymously:', res.user && res.user.uid);
          return res.user;
        } catch (e) {
          console.error('Anonymous sign-in failed:', e);
          throw e;
        }
      }

      // Handle file selection from input - store the actual File objects in form.files
      const handleFileChange = (e) => {
        const files = Array.from(e.target.files || []);
        const mapped = files.map(f => ({ name: f.name, type: f.type, file: f, size: f.size }));
        setForm(prev => ({ ...prev, files: [...prev.files, ...mapped] }));
      };

      const removeSelectedFile = (index) => {
        setForm(prev => ({ ...prev, files: prev.files.filter((_, i) => i !== index) }));
      };

      // ---------- Robust saveStay (ensures auth, uses actual File objects, logs) ----------
      const saveStay = async () => {
        try {
          if (!form.guestName || !form.checkInDate) {
            alert('Please fill guest name and check-in date.');
            return;
          }

          // Pull actual File objects from input if present; fallback to form.files[].file
          const inputEl = document.querySelector('input[type="file"]');
          let selectedFiles = [];
          if (inputEl && inputEl.files && inputEl.files.length > 0) {
            selectedFiles = Array.from(inputEl.files);
            console.log('saveStay: using files from file input', selectedFiles.map(f=>f.name));
          } else {
            // fallback to form.files (these entries have .file when chosen via our input)
            selectedFiles = (form.files || []).map(f => f.file).filter(Boolean);
            console.log('saveStay: using files from form.files', selectedFiles.map(f=>f && f.name));
          }

          if (!selectedFiles || selectedFiles.length === 0) {
            alert('Please choose at least one ID file before saving.');
            console.warn('saveStay aborted: no files found. form.files:', form.files);
            return;
          }

          // Ensure signed in
          await ensureAnonAuth();

          setSaving(true);
          console.log('saveStay: creating Firestore document...');

          // create Firestore doc
          const docRef = await db.collection('stays').add({
            guestName: form.guestName,
            checkInDate: form.checkInDate,
            checkOutDate: form.checkOutDate || null,
            createdAt: new Date().toISOString()
          });

          console.log('saveStay: created doc', docRef.id);

          const uploadedFiles = [];

          // upload sequentially with progress logs
          for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            try {
              console.log(`Uploading file ${i+1}/${selectedFiles.length}:`, file.name);
              const safe = file.name.replace(/\s+/g,'_');
              const path = `guestIDs/${docRef.id}/${Date.now()}_${safe}`;
              const ref = storage.ref(path);
              const task = ref.put(file);

              await new Promise((resolve, reject) => {
                task.on('state_changed',
                  snap => {
                    const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
                    console.log(`Upload progress ${file.name}: ${pct}%`);
                  },
                  err => {
                    console.error('Upload failed for', file.name, err);
                    reject(err);
                  },
                  async () => {
                    try {
                      const url = await task.snapshot.ref.getDownloadURL();
                      uploadedFiles.push({ name: file.name, type: file.type || '', url, path, uploadDate: new Date().toISOString() });
                      console.log('Uploaded', file.name, '->', url);
                      resolve();
                    } catch (e) {
                      console.error('Failed to getDownloadURL for', file.name, e);
                      reject(e);
                    }
                  }
                );
              });

            } catch (e) {
              console.error('Error uploading file', file.name, e);
              // continue with other files but record failure
            }
          }

          // Update Firestore doc with uploaded file metadata
          try {
            await docRef.update({ files: uploadedFiles });
            console.log('saveStay: updated doc with files', uploadedFiles);
          } catch (e) {
            console.error('Failed to update Firestore doc with files array', e);
            alert('Saved stay but failed to attach files metadata. See console.');
          }

          // reset UI
          setForm({ guestName: '', checkInDate: '', checkOutDate: '', files: [] });
          if (fileInputRef.current) fileInputRef.current.value = null;
          setShowUpload(false);

        } catch (err) {
          console.error('saveStay unexpected error:', err);
          alert('Failed to save stay. See console for details.');
        } finally {
          setSaving(false);
        }
      };

      // ---------- Robust deleteStay (delete storage files then Firestore doc) ----------
      const deleteStay = async (stay) => {
        if (!confirm('Delete this stay and all files?')) return;
        try {
          console.log('deleteStay: starting for', stay.id);

          // delete files in storage
          if (Array.isArray(stay.files) && stay.files.length) {
            for (const f of stay.files) {
              if (f.path) {
                try {
                  console.log('deleteStay: deleting', f.path);
                  await storage.ref(f.path).delete();
                } catch (e) {
                  console.warn('deleteStay: failed deleting', f.path, e);
                }
              }
            }
          } else {
            console.log('deleteStay: no files to delete for', stay.id);
          }

          // delete firestore doc
          try {
            await db.collection('stays').doc(stay.id).delete();
            console.log('deleteStay: deleted doc', stay.id);
          } catch (e) {
            console.error('deleteStay: failed to delete doc', stay.id, e);
            alert('Some files deleted (if any), but failed to remove Firestore doc. See console.');
          }

        } catch (err) {
          console.error('deleteStay unexpected error:', err);
          alert('Delete failed. See console for details.');
        }
      };


      if (loading) return (<div className="min-h-screen flex items-center justify-center p-6">Loading...</div>);

      return (
        <div className="p-6 max-w-6xl mx-auto">
          <div className="bg-white rounded-lg shadow p-6 mb-6 flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold">Villa Guest ID Manager</h1>
              <p className="text-gray-600">All files stored in Firebase.</p>
            </div>
            <div>
              <button onClick={() => setShowUpload(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                <Upload size={18}/> New Guest Stay
              </button>
            </div>
          </div>

          <div className="grid gap-4">
            {stays.length === 0 ? (
              <div className="bg-white p-12 rounded-lg shadow text-center">
                <FileText size={48} />
                <p className="mt-4 text-gray-600">No Guest Stays Yet. Click "New Guest Stay" to upload IDs.</p>
              </div>
            ) : stays.map(stay => (
              <div key={stay.id} className="bg-white rounded-lg shadow p-6 flex items-center justify-between">
                <div>
                  <h3 className="text-xl font-semibold">{stay.guestName}</h3>
                  <div className="text-sm text-gray-600 mt-2 flex gap-4">
                    <span className="flex items-center gap-1"><Calendar size={14}/> {new Date(stay.checkInDate).toLocaleDateString()}</span>
                    {stay.checkOutDate && <span className="flex items-center gap-1"><Calendar size={14}/> {new Date(stay.checkOutDate).toLocaleDateString()}</span>}
                    <span className="flex items-center gap-1"><FileText size={14}/> {(stay.files||[]).length} IDs</span>
                  </div>
                </div>

                <div className="flex gap-2">
                  <button onClick={() => { setSelectedStay(stay); setShowView(true); }} className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg flex items-center gap-2"><Eye size={16}/> View</button>
                  <button onClick={() => deleteStay(stay)} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg flex items-center gap-2"><Trash2 size={16}/></button>
                </div>
              </div>
            ))}
          </div>

          {/* Upload Modal */}
          {showUpload && (
            <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-lg max-w-2xl w-full p-6 overflow-y-auto max-h-[90vh]">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-2xl font-bold">New Guest Stay</h2>
                  <button onClick={() => { setShowUpload(false); setForm({ guestName: '', checkInDate: '', checkOutDate: '', files: [] }); if (fileInputRef.current) fileInputRef.current.value = null; }}><X size={20}/></button>
                </div>

                <div className="space-y-4">
                  <input className="w-full p-3 border rounded" placeholder="Guest name" value={form.guestName} onChange={e => setForm(prev => ({ ...prev, guestName: e.target.value }))} />

                  <div className="grid grid-cols-2 gap-4">
                    <input type="date" className="p-3 border rounded" value={form.checkInDate} onChange={e => setForm(prev => ({ ...prev, checkInDate: e.target.value }))} />
                    <input type="date" className="p-3 border rounded" value={form.checkOutDate} onChange={e => setForm(prev => ({ ...prev, checkOutDate: e.target.value }))} />
                  </div>

                  <div className="p-6 border-2 border-dashed rounded text-center">
                    <input ref={fileInputRef} type="file" multiple accept="image/*,.pdf" className="hidden" onChange={handleFileChange} />
                    <div className="cursor-pointer" onClick={() => fileInputRef.current && fileInputRef.current.click()}>
                      <Upload size={48} />
                      <p className="text-gray-600 mt-2">Click to select files or drag & drop</p>
                    </div>
                  </div>

                  {form.files.length > 0 && (
                    <div className="bg-gray-50 p-3 rounded">
                      <p className="font-medium mb-2">Selected files</p>
                      {form.files.map((f, i) => (
                        <div key={i} className="flex justify-between items-center mb-2">
                          <div>
                            <div className="text-sm font-medium">{f.name}</div>
                            <div className="text-xs text-gray-500">{Math.round((f.size||0)/1024)} KB</div>
                          </div>
                          <button onClick={() => removeSelectedFile(i)} className="text-red-600"><Trash2 size={16}/></button>
                        </div>
                      ))}
                    </div>
                  )}

                  <div className="flex gap-3">
                    <button onClick={saveStay} disabled={saving} className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded">{saving ? 'Saving...' : 'Save Stay'}</button>
                    <button onClick={() => { setShowUpload(false); setForm({ guestName: '', checkInDate: '', checkOutDate: '', files: [] }); if (fileInputRef.current) fileInputRef.current.value = null; }} className="flex-1 bg-gray-200 py-3 rounded">Cancel</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* View Modal */}
          {showView && selectedStay && (
            <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-lg max-w-3xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-2xl font-bold">{selectedStay.guestName}</h2>
                  <button onClick={() => setShowView(false)}><X size={20}/></button>
                </div>

                <div className="space-y-4">
                  {(selectedStay.files || []).map((file, i) => (
                    <div key={i} className="border p-3 rounded">
                      <div className="flex justify-between items-center mb-2">
                        <div className="font-medium">{file.name}</div>
                        <a href={file.url} target="_blank" rel="noreferrer" className="bg-indigo-600 text-white px-3 py-1 rounded">Open</a>
                      </div>
                      {file.type && file.type.startsWith('image/') ? (
                        <img src={file.url} alt={file.name} className="w-full rounded" />
                      ) : (
                        <iframe src={file.url} className="w-full h-96 rounded border"></iframe>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

  <!--
    IMPORTANT:
    - Enable Anonymous Auth: Firebase Console -> Authentication -> Sign-in method -> Anonymous -> Enable
    - Storage Rules (recommended for production after testing):
      rules_version = '2';
      service firebase.storage {
        match /b/{bucket}/o {
          match /guestIDs/{stayId}/{allPaths=**} {
            allow read: if true; // or request.auth != null for privacy
            allow write, delete: if request.auth != null;
          }
        }
      }
    - Firestore Rules (starter):
      rules_version = '2';
      service cloud.firestore {
        match /databases/{database}/documents {
          match /stays/{stayId} {
            allow read: if true;
            allow create: if request.auth != null;
            allow update, delete: if false;
          }
        }
      }
  -->
</body>
</html>
