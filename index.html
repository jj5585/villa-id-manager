<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Villa Guest ID Manager</title>

  <!-- React UMD + Babel (single-file JSX) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat SDK (works in single-file HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Optional tiny favicon -->
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAKElEQVR4AWMYeP///xkYGBgYGRgY/4YGBgYGBhA0TAxMDAwMDAwAAByGwzqKzJ3tQAAAABJRU5ErkJggg==" />
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">

    // --------------------------------------
    // FIREBASE: your correct config
    // --------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyC7UUuinlN5BGbjAOCTVTjQH0ojiO63dPA",
      authDomain: "villa-id-manager.firebaseapp.com",
      projectId: "villa-id-manager",
      storageBucket: "villa-id-manager",   // <-- EXACT bucket name
      messagingSenderId: "741560826934",
      appId: "1:741560826934:web:ded52efe671d6d7200ec97",
      measurementId: "G-BFJVWVRJGW"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const storage = firebase.storage();
    const db = firebase.firestore();

    // Sign in anonymously so writes succeed
    auth.signInAnonymously().catch(err => console.warn("Auth Error:", err));


    // ----------------------------- Icons -----------------------------
    const Upload = ({ size=24 }) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2"
           strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );

    const Calendar = ({ size=24 }) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2"
           strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
        <rect x="3" y="4" width="18" height="18" rx="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const FileText = ({ size=24 }) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2"
           strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
      </svg>
    );

    const Eye = ({ size=24 }) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2"
           strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
    );

    const Trash2 = ({ size=24 }) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2"
           strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    );

    const X = ({ size=24 }) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2"
           strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );


    // -------------------------- MAIN APP --------------------------
    const { useState, useEffect, useRef } = React;

    function App() {

      const [stays, setStays] = useState([]);
      const [loading, setLoading] = useState(true);

      const [showUpload, setShowUpload] = useState(false);
      const [showView, setShowView] = useState(false);
      const [selectedStay, setSelectedStay] = useState(null);

      const [form, setForm] = useState({
        guestName: "",
        checkInDate: "",
        checkOutDate: "",
        files: []
      });

      const fileInput = useRef(null);

      useEffect(() => {
        // Listen to real-time Firestore updates
        const unsub = db.collection("stays")
          .orderBy("checkInDate", "desc")
          .onSnapshot(snap => {
            const arr = [];
            snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
            setStays(arr);
            setLoading(false);
          });

        return unsub;
      }, []);


      // Add new files
      const handleFileChange = e => {
        const files = Array.from(e.target.files || []);
        const mapped = files.map(f => ({
          name: f.name,
          type: f.type,
          file: f,
          size: f.size
        }));
        setForm(prev => ({ ...prev, files: [...prev.files, ...mapped] }));
      };


      // Upload file to Firebase Storage
      async function uploadToStorage(fileObj, stayId) {
        const safeName = fileObj.name.replace(/\s+/g, "_");
        const path = `guestIDs/${stayId}/${Date.now()}_${safeName}`;

        const ref = storage.ref(path);
        await ref.put(fileObj.file);
        const url = await ref.getDownloadURL();

        return {
          name: fileObj.name,
          type: fileObj.type,
          url,
          path,
          uploadDate: new Date().toISOString()
        };
      }


      // Save a new stay
      async function saveStay() {
        if (!form.guestName || !form.checkInDate || form.files.length === 0) {
          alert("Fill guest name, date & at least one ID.");
          return;
        }

        const docRef = await db.collection("stays").add({
          guestName: form.guestName,
          checkInDate: form.checkInDate,
          checkOutDate: form.checkOutDate || null,
          createdAt: new Date().toISOString()
        });

        const stayId = docRef.id;

        const uploaded = [];
        for (let f of form.files) {
          uploaded.push(await uploadToStorage(f, stayId));
        }

        await docRef.update({ files: uploaded });

        setForm({ guestName: "", checkInDate: "", checkOutDate: "", files: [] });
        setShowUpload(false);
      }


      // Delete stay + files
      async function deleteStay(stay) {
        if (!confirm("Delete this stay and its files?")) return;

        for (let f of stay.files || []) {
          try {
            await storage.ref(f.path).delete();
          } catch (e) {
            console.warn("Delete file error", f.path, e);
          }
        }

        await db.collection("stays").doc(stay.id).delete();
      }


      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center text-xl text-gray-600">
            Loading...
          </div>
        );
      }


      return (
        <div className="p-6 max-w-5xl mx-auto">

          <div className="bg-white shadow rounded-lg p-6 mb-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-bold">Villa Guest ID Manager</h1>
                <p className="text-gray-600">All files stored in Firebase.</p>
              </div>

              <button
                className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2"
                onClick={() => setShowUpload(true)}
              >
                <Upload size={18}/> New Guest Stay
              </button>
            </div>
          </div>


          {stays.length === 0 ? (
            <div className="bg-white p-12 text-center shadow rounded-lg">
              <FileText size={48} className="mx-auto text-gray-400 mb-3" />
              <p className="text-lg font-medium">No Guest Stays Yet</p>
              <p className="text-sm text-gray-500 mt-1">
                Use “New Guest Stay” to upload IDs.
              </p>
            </div>
          ) : (
            stays.map(stay => (
              <div key={stay.id} className="bg-white shadow p-6 rounded-lg mb-4">
                <div className="flex justify-between">
                  <div>
                    <p className="text-xl font-bold">{stay.guestName}</p>
                    <p className="text-gray-600 text-sm flex gap-3 mt-1">
                      <span className="flex items-center gap-1">
                        <Calendar size={14}/> {new Date(stay.checkInDate).toLocaleDateString()}
                      </span>

                      {stay.checkOutDate && (
                        <span className="flex items-center gap-1">
                          <Calendar size={14}/> {new Date(stay.checkOutDate).toLocaleDateString()}
                        </span>
                      )}

                      <span className="flex items-center gap-1">
                        <FileText size={14}/> {(stay.files||[]).length} IDs
                      </span>
                    </p>
                  </div>

                  <div className="flex gap-2">
                    <button
                      onClick={() => { setSelectedStay(stay); setShowView(true); }}
                      className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg flex items-center gap-1"
                    >
                      <Eye size={16}/> View
                    </button>

                    <button
                      onClick={() => deleteStay(stay)}
                      className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg flex items-center gap-1"
                    >
                      <Trash2 size={16}/>
                    </button>
                  </div>
                </div>
              </div>
            ))
          )}


          {/* Upload Modal */}
          {showUpload && (
            <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4">
              <div className="bg-white rounded-lg shadow-lg p-6 max-w-xl w-full">

                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-2xl font-bold">New Guest Stay</h2>
                  <button onClick={() => setShowUpload(false)}><X size={24}/></button>
                </div>

                <div className="space-y-4">

                  <input
                    className="w-full p-3 border rounded-lg"
                    type="text"
                    placeholder="Guest Name"
                    value={form.guestName}
                    onChange={e => setForm({ ...form, guestName: e.target.value })}
                  />

                  <div className="grid grid-cols-2 gap-4">
                    <input
                      type="date"
                      className="p-3 border rounded-lg"
                      value={form.checkInDate}
                      onChange={e => setForm({ ...form, checkInDate: e.target.value })}
                    />
                    <input
                      type="date"
                      className="p-3 border rounded-lg"
                      value={form.checkOutDate}
                      onChange={e => setForm({ ...form, checkOutDate: e.target.value })}
                    />
                  </div>

                  <div className="p-6 border-2 border-dashed rounded-lg text-center">
                    <input
                      type="file"
                      multiple
                      accept="image/*,.pdf"
                      className="hidden"
                      ref={fileInput}
                      onChange={handleFileChange}
                    />

                    <div
                      className="cursor-pointer flex flex-col items-center"
                      onClick={() => fileInput.current.click()}
                    >
                      <Upload size={48} className="text-gray-400 mb-3"/>
                      <p className="text-gray-600">Click to upload or drag here</p>
                    </div>
                  </div>

                  {form.files.length > 0 && (
                    <div className="bg-gray-50 p-4 rounded-lg">
                      <p className="font-medium mb-2">Selected Files</p>
                      {form.files.map((f, i) => (
                        <div key={i} className="flex justify-between items-center mb-1">
                          <span>{f.name}</span>
                          <button
                            onClick={() =>
                              setForm(prev => ({ ...prev, files: prev.files.filter((_, idx) => idx !== i) }))
                            }
                            className="text-red-600"
                          >
                            <Trash2 size={16}/>
                          </button>
                        </div>
                      ))}
                    </div>
                  )}

                  <button
                    onClick={saveStay}
                    className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700"
                  >
                    Save Stay
                  </button>

                </div>
              </div>
            </div>
          )}


          {/* View Modal */}
          {showView && selectedStay && (
            <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4">
              <div className="bg-white rounded-lg shadow-lg p-6 max-w-3xl w-full">

                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-2xl font-bold">{selectedStay.guestName}</h2>
                  <button onClick={() => setShowView(false)}><X size={24}/></button>
                </div>

                <div className="space-y-4">
                  {(selectedStay.files || []).map((file, i) => (
                    <div key={i} className="border p-4 rounded-lg">
                      <div className="flex justify-between mb-3">
                        <span className="font-medium">{file.name}</span>
                        <a
                          href={file.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="bg-indigo-600 text-white px-3 py-2 rounded-lg"
                        >
                          Download
                        </a>
                      </div>

                      {file.type.startsWith("image/") ? (
                        <img src={file.url} className="rounded-lg w-full"/>
                      ) : (
                        <iframe src={file.url} className="w-full h-96 rounded-lg border"></iframe>
                      )}
                    </div>
                  ))}
                </div>

              </div>
            </div>
          )}

        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));

  </script>
</body>
</html>
