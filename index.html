<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Villa Guest ID Manager — Login</title>

  <!-- React, Babel, Tailwind (single-file usage) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAKElEQVR4AWMYeP///xkYGBgYGRgY/4YGBgYGBhA0TAxMDAwMDAwAAByGwzqKzJ3tQAAAABJRU5ErkJggg==" />
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen antialiased">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ------------- FIREBASE CONFIG -------------
  const firebaseConfig = {
  apiKey: "AIzaSyC7UUuinlN5BGbjAOCTVTjQH0ojiO63dPA",
  authDomain: "villa-id-manager.firebaseapp.com",
  projectId: "villa-id-manager",
  // <-- use this exact value (no gs://)
  storageBucket: "villa-id-manager.firebasestorage.app",
  messagingSenderId: "741560826934",
  appId: "1:741560826934:web:ded52efe671d6d7200ec97",
  measurementId: "G-BFJVWVRJGW"
};


    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ------------- ICONS -------------
    const UploadIcon = ({size=18}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>);
    const UserIcon = ({size=18}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-3-3.87"></path><path d="M4 21v-2a4 4 0 0 1 3-3.87"></path><circle cx="12" cy="7" r="4"></circle></svg>);
    const GoogleIcon = ({size=16}) => (<svg width={size} height={size} viewBox="0 0 533.5 544.3"><path fill="#4285f4" d="M533.5 278.4c0-17.1-1.4-33.6-4.1-49.6H272v93.9h147.1c-6.1 33.1-24.5 61.2-52.6 80v66.1h84.9C500.3 423 533.5 355.1 533.5 278.4z"/><path fill="#34a853" d="M272 544.3c71.9 0 132.3-23.9 176.4-65.1l-84.9-66.1c-23.6 15.9-54 25.3-91.5 25.3-70.3 0-130-47.4-151.3-111.3H34.9v69.9C78.8 486.1 169.3 544.3 272 544.3z"/><path fill="#fbbc04" d="M120.7 327.1c-10.9-32.6-10.9-67.8 0-100.4V156.8H34.9C12.4 201.6 0 246.6 0 278.4s12.4 76.8 34.9 121.6l85.8-73z"/><path fill="#ea4335" d="M272 109.8c39.1 0 74.3 13.5 102 40.3l76.5-76.5C403.9 24 343.5 0 272 0 169.3 0 78.8 58.2 34.9 156.8l85.8 69.9C142 157.2 201.7 109.8 272 109.8z"/></svg>);

    // ------------- Login Component -------------
    function LoginView({ onAuthSuccess }) {
      const [mode, setMode] = useState('login'); // 'login' | 'signup'
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      useEffect(() => { setError(''); }, [email, password, mode]);

      const signInWithEmail = async () => {
        setLoading(true); setError('');
        try {
          if (mode === 'signup') {
            await auth.createUserWithEmailAndPassword(email, password);
          } else {
            await auth.signInWithEmailAndPassword(email, password);
          }
          onAuthSuccess();
        } catch (e) {
          setError(e.message || 'Auth error');
          console.error('email auth error', e);
        } finally { setLoading(false); }
      };

      const signInWithGoogle = async () => {
        setLoading(true); setError('');
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider);
          onAuthSuccess();
        } catch (e) {
          setError(e.message || 'Google sign-in failed');
          console.error('google sign-in error', e);
        } finally { setLoading(false); }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="w-full max-w-md bg-white rounded-xl shadow p-6">
            <div className="flex items-center gap-3 mb-4">
              <div className="bg-indigo-50 p-2 rounded"><UserIcon size={22} /></div>
              <div>
                <h2 className="text-xl font-semibold">Sign {mode === 'signup' ? 'up' : 'in'}</h2>
                <p className="text-sm text-gray-500">Use email/password, Google, or continue as guest</p>
              </div>
            </div>

            {error && <div className="bg-red-50 text-red-700 p-2 rounded mb-3 text-sm">{error}</div>}

            <div className="space-y-3">
              <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-3 border rounded" />
              <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 border rounded" />
              <button onClick={signInWithEmail} disabled={loading || !email || !password} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded">{loading ? 'Working...' : (mode === 'signup' ? 'Create account' : 'Sign in')}</button>

              <div className="flex items-center gap-2">
                <hr className="flex-1" />
                <span className="text-xs text-gray-400">or</span>
                <hr className="flex-1" />
              </div>

              <button onClick={signInWithGoogle} disabled={loading} className="w-full border py-2 rounded flex items-center justify-center gap-2">
                <GoogleIcon/> Sign in with Google
              </button>


              <div className="text-sm text-center text-gray-600">
                <button onClick={() => setMode(m => m==='signup' ? 'login' : 'signup')} className="text-indigo-600 hover:underline">
                  {mode === 'signup' ? 'Have an account? Sign in' : "Don't have an account? Sign up"}
                </button>
              </div>
            </div>

            <p className="mt-4 text-xs text-gray-400">Tip: Guest accounts are anonymous and cannot recover data if you clear browser storage; sign up with email for persistence across devices.</p>
          </div>
        </div>
      );
    }

    // ------------- Main App (gated) -------------
    function VillaApp({ user }) {
      // user is firebase.User
      const [stays, setStays] = useState([]);
      const [loading, setLoading] = useState(true);

      const [showUpload, setShowUpload] = useState(false);
      const [showView, setShowView] = useState(false);
      const [selectedStay, setSelectedStay] = useState(null);

      const [form, setForm] = useState({ guestName: '', checkInDate: '', checkOutDate: '', files: [] });
      const [saving, setSaving] = useState(false);

      const fileInputRef = useRef(null);

      useEffect(() => {
        // only show stays owned by current user
        const q = db.collection('stays').where('ownerUid','==', user.uid).orderBy('checkInDate','desc');
        const unsub = q.onSnapshot(snap => {
          const arr = [];
          snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
          setStays(arr);
          setLoading(false);
        }, err => {
          console.error('stays snapshot err', err); setLoading(false);
        });
        return unsub;
      }, [user.uid]);

      const handleFileChange = (e) => {
        const files = Array.from(e.target.files || []);
        const mapped = files.map(f => ({ name: f.name, type: f.type, file: f, size: f.size }));
        setForm(prev => ({ ...prev, files: [...prev.files, ...mapped] }));
      };

      const removeSelectedFile = (index) => setForm(prev => ({ ...prev, files: prev.files.filter((_,i)=>i!==index) }));

      const saveStay = async () => {
        try {
          if (!form.guestName || !form.checkInDate) { alert('Enter guest name and check-in'); return; }
          // gather files
          const inputEl = fileInputRef.current;
          let selectedFiles = [];
          if (inputEl && inputEl.files && inputEl.files.length) selectedFiles = Array.from(inputEl.files);
          else selectedFiles = (form.files || []).map(x => x.file).filter(Boolean);

          if (!selectedFiles.length) { alert('Choose at least one file'); return; }
          setSaving(true);

          // create doc with ownerUid
          const docRef = await db.collection('stays').add({
            ownerUid: user.uid,
            guestName: form.guestName,
            checkInDate: form.checkInDate,
            checkOutDate: form.checkOutDate || null,
            createdAt: new Date().toISOString()
          });

          const uploadedFiles = [];
          for (let i=0;i<selectedFiles.length;i++) {
            const file = selectedFiles[i];
            try {
              const safe = file.name.replace(/\s+/g,'_');
              const path = `guestIDs/${docRef.id}/${Date.now()}_${safe}`;
              const ref = storage.ref(path);
              const task = ref.put(file);
              await new Promise((resolve,reject)=>{
                task.on('state_changed', ()=>{}, err=>reject(err), async ()=>{
                  const url = await task.snapshot.ref.getDownloadURL();
                  uploadedFiles.push({ name: file.name, type: file.type||'', url, path, uploadDate: new Date().toISOString() });
                  resolve();
                });
              });
            } catch (e) {
              console.warn('file upload failed for', file.name, e);
            }
          }

          // attach uploaded files metadata
          await db.collection('stays').doc(docRef.id).update({ files: uploadedFiles });

          setForm({ guestName: '', checkInDate: '', checkOutDate: '', files: [] });
          if (fileInputRef.current) fileInputRef.current.value = null;
          setShowUpload(false);

        } catch (e) {
          console.error('saveStay error', e);
          alert('Failed to save stay — see console.');
        } finally {
          setSaving(false);
        }
      };

      const deleteStay = async (stay) => {
        if (!confirm('Delete this stay and its files?')) return;
        try {
          // delete files
          if (Array.isArray(stay.files)) {
            for (const f of stay.files) {
              if (f.path) {
                try { await storage.ref(f.path).delete(); } catch(e){ console.warn('failed to delete file', e); }
              }
            }
          }
          // delete doc
          await db.collection('stays').doc(stay.id).delete();
        } catch (e) {
          console.error('deleteStay error', e);
          alert('Delete failed — see console.');
        }
      };

      const signOut = () => auth.signOut();

      return (
        <div className="max-w-6xl mx-auto p-6">
          <header className="bg-white rounded-lg shadow p-4 mb-6 flex items-center justify-between gap-4">
            <div>
              <h1 className="text-2xl font-semibold">Villa Guest ID Manager</h1>
              <p className="text-sm text-gray-500">Signed in as {user.isAnonymous ? 'Guest (anonymous)' : (user.email || user.uid)}</p>
            </div>
            <div className="flex items-center gap-3">
              <button onClick={() => setShowUpload(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded flex items-center gap-2"><UploadIcon/> New Guest Stay</button>
              <div className="text-sm text-gray-600">|</div>
              <button onClick={signOut} className="text-sm text-gray-700 hover:underline">Sign out</button>
            </div>
          </header>

          <main>
            {loading ? <div>Loading…</div> : (
              <>
                {stays.length === 0 ? (
                  <div className="bg-white rounded-lg p-8 shadow text-center">No stays yet. Add a new stay to upload IDs.</div>
                ) : (
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {stays.map(stay => (
                      <div key={stay.id} className="bg-white rounded-lg shadow p-4 flex flex-col">
                        <div className="flex items-start justify-between">
                          <div>
                            <div className="font-medium text-lg">{stay.guestName}</div>
                            <div className="text-xs text-gray-500 mt-1">{new Date(stay.checkInDate).toLocaleDateString()}</div>
                          </div>
                          <div className="flex gap-2">
                            <button onClick={() => { setSelectedStay(stay); setShowView(true); }} className="bg-blue-500 text-white px-2 py-1 rounded">View</button>
                            <button onClick={() => deleteStay(stay)} className="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
                          </div>
                        </div>
                        <div className="mt-3 text-sm text-gray-600">{(stay.files||[]).length} file(s)</div>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}
          </main>

          {/* Upload Modal */}
          {showUpload && (
            <div className="fixed inset-0 z-40 flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-black/40" onClick={()=>setShowUpload(false)}></div>
              <div className="relative w-full sm:max-w-2xl bg-white rounded-lg shadow p-4 max-h-[90vh] overflow-auto">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-xl font-semibold">New Guest Stay</h2>
                  <button onClick={()=>setShowUpload(false)}>Close</button>
                </div>

                <div className="space-y-3">
                  <input type="text" placeholder="Guest name" value={form.guestName} onChange={e => setForm(prev=>({...prev, guestName: e.target.value}))} className="w-full p-3 border rounded" />
                  <div className="grid grid-cols-2 gap-3">
                    <input type="date" value={form.checkInDate} onChange={e => setForm(prev=>({...prev, checkInDate: e.target.value}))} className="p-3 border rounded" />
                    <input type="date" value={form.checkOutDate} onChange={e => setForm(prev=>({...prev, checkOutDate: e.target.value}))} className="p-3 border rounded" />
                  </div>

                  <div className="p-4 border-2 border-dashed rounded text-center">
                    <input ref={fileInputRef} type="file" multiple accept="image/*,.pdf" className="hidden" onChange={(e)=>{ const files = Array.from(e.target.files||[]); setForm(prev => ({...prev, files: [...prev.files, ...files.map(f=>({name:f.name,file:f,size:f.size,type:f.type}))]})) }} />
                    <div className="cursor-pointer" onClick={()=>fileInputRef.current && fileInputRef.current.click()}>
                      <div className="inline-flex items-center gap-2 bg-gray-50 px-4 py-2 rounded">
                        <UploadIcon/> Select files
                      </div>
                      <p className="text-xs text-gray-500 mt-2">Images and PDFs accepted</p>
                    </div>
                  </div>

                  {form.files.length > 0 && (
                    <div className="bg-gray-50 p-3 rounded">
                      <div className="text-sm font-medium mb-2">Selected files</div>
                      <div className="space-y-2">
                        {form.files.map((f,i) => (
                          <div key={i} className="flex items-center justify-between">
                            <div>
                              <div className="text-sm truncate">{f.name}</div>
                              <div className="text-xs text-gray-500">{Math.round((f.size||0)/1024)} KB</div>
                            </div>
                            <button onClick={() => setForm(prev=>({...prev, files: prev.files.filter((_,idx)=>idx!==i)}))} className="text-red-600">Remove</button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  <div className="flex gap-3">
                    <button onClick={saveStay} disabled={saving} className="flex-1 bg-indigo-600 text-white py-2 rounded">{saving ? 'Saving...' : 'Save Stay'}</button>
                    <button onClick={()=>{ setShowUpload(false); setForm({ guestName: '', checkInDate: '', checkOutDate: '', files: [] }); if (fileInputRef.current) fileInputRef.current.value=null; }} className="flex-1 bg-gray-100 py-2 rounded">Cancel</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* View Modal */}
          {showView && selectedStay && (
            <div className="fixed inset-0 z-40 flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-black/40" onClick={()=>setShowView(false)} />
              <div className="relative w-full sm:max-w-3xl bg-white rounded-lg shadow p-4 max-h-[90vh] overflow-auto">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-xl font-semibold">{selectedStay.guestName}</h2>
                  <button onClick={()=>setShowView(false)}>Close</button>
                </div>

                <div className="space-y-4">
                  {(selectedStay.files || []).map((file,i) => (
                    <div key={i} className="border p-3 rounded">
                      <div className="flex justify-between items-center mb-2">
                        <div className="font-medium truncate">{file.name}</div>
                        <a href={file.url} target="_blank" rel="noreferrer" className="bg-indigo-600 text-white px-3 py-1 rounded text-sm">Open</a>
                      </div>
                      {file.type && file.type.startsWith('image/') ? (
                        <img src={file.url} alt={file.name} className="w-full rounded" />
                      ) : (
                        <iframe src={file.url} className="w-full h-96 rounded border" />
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ------------- Root wrapper: listens to auth state -------------
    function Root() {
      const [authReady, setAuthReady] = useState(false);
      const [user, setUser] = useState(null);

      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
          setUser(u);
          setAuthReady(true);
          console.log('Auth state changed:', u && (u.email || u.uid || 'anonymous'));
        });
        return unsub;
      }, []);

      if (!authReady) return (<div className="min-h-screen flex items-center justify-center">Initializing auth…</div>);
      if (!user) return <LoginView onAuthSuccess={() => { /* onAuthSuccess: auth state listener will flip UI */ }} />;

      return <VillaApp user={user} />;
    }

    ReactDOM.render(<Root />, document.getElementById('root'));
  </script>

  <!--
    SECURITY / RULES reminders (set these in Firebase Console):

    Firestore (restrict documents to owners):
    ------------------------------------------------
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /stays/{stayId} {
          allow read, write: if request.auth != null && request.auth.uid == resource.data.ownerUid;
          allow create: if request.auth != null; // create allowed; ownerUid is set by client
        }
      }
    }

    Storage (restrict to owner paths):
    ------------------------------------------------
    rules_version = '2';
    service firebase.storage {
      match /b/{bucket}/o {
        match /guestIDs/{stayId}/{allPaths=**} {
          allow read, write, delete: if request.auth != null && request.auth.uid == request.resource.metadata.ownerUid;
        }
      }
    }

    NOTE: The storage rule above expects you to set owner metadata when uploading, or you can instead
    allow write only when the authenticated user owns the Firestore doc (more advanced). If you prefer,
    we can change the upload to store files under a bucket path that encodes owner uid and then enforce request.auth.uid == ownerUid.

    Final notes:
    - For Google sign-in to work, enable the provider in Firebase Console -> Authentication -> Sign-in method -> Google.
    - For email/password sign-up, enable Email/Password in the same panel.
  -->
</body>
</html>
